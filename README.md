# Контроллер теплицы
## GHControl BFB Mark 2

***Дисклеймер:*** Этот проект всего лишь мой извращенный способ изучения языка С++. Поэтому в коде может быть что угодно, особенно в ветке Mark2, в master же буду выкладывать хоть как-то, но рабочий код ;)  


### Программная часть ###
#### **Библиотека *`GHControlClass`***  
Содержит несколько классов для работы с вводом/выводом, термометрами и сенсорами, а также системным временем. Упрощает опрос и настройку датчиков, а также публикацию ввиде mqqt топиков.

##### Класс *SysTime* - системное время:
- открытые члены класса:
      uint8_t sec, min, hour, day; //соответственно секунды, минуты, часы, дни
                                   //с момента запуска
      bool newSec;                 //флаг понимается при старте новой секунды
- методы:
      void tick();      // метод, должен вызываться в loop() тикает секунды
      String hwclock(); // выводит текущее время в формате Д ЧЧ:ММ:СС

##### Класс *AnalogChannel* - аналоговый тег
- конструктор - создает тег без описания и диапазоном от 0 до 100 и увеличивает общий счетчик на 1.
- открытые члены класса:
      static uint8 counter; //счетчик общего количества сконфигурированных входов
      float val;            //текущее значение, обновляется вызовом value()
      String descr;         //описание сигнала (используется как заголовок mqtt-топика)
- приватные    
- методы:
      void init();          //инициализация, тоже что конструктор.
      void setSetting(      //задаем настройки мин-макс в требуемых единицах измерения
        long minValue,      //
        long maxValue);     //
      float value();        //возвращает отмасштабированное значение входа и обновляет val

##### Класс *DigitalChannel* - дискретный тег (вход)



---


### Аппаратная часть ###
- Контроллер плата: **Lolin NodeMCU v.3**
- DC-DC понижающий модуль: на базе **XL4015**
- Контролер заряда и защиты: **TP4056**
- DC-DC повышающий модуль: **MT3608**
- 2 диода Шоттки: **1N5821**
- Резисторы: **разные** *см. схему ниже*
- Транзистор, N-канал: **КП505А** [[ссылка](https://www.chipdip.ru/product/kp505a)]
- Аккумуляторная батарея: тип **18650**  

Данная схема позволяет реализовать ИБП для контроллера. Батарея всегда остается заряженной, при том что в штатном состоянии питание схемы идет от внешнего источника 12 В (клеммы **14-15**). На пин **D0** подается сигнал для отслеживания состояния внешнего источника питания.

Подключение термометров по шине 1-wire происходит через разъем RJ-11 6P4C.

**1-9** клеммы В/В с бесперебойным питанием 5V. (Именно ради этих 5 вольт стоит повышающий модуль MT3608)

**10-12** аналоговый вход для потенциометра, которым выставляем уставку по температуре

**13** клемма - минус на управление твердотельным реле Fotek SSR-40 DA [[пример схемы](http://alexgyver.ru/wp-content/uploads/2017/01/%D0%BC%D0%BE%D1%81%D1%84%D0%B5%D1%82_bb.jpg)]

![Схема](/img/mark2_bb_with_mosfet.png)
Фото для этой [схемы](/img/mark2_bb.png)
![Фото](/img/mark2_foto.png)
